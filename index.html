<!doctype html>
<!--
	Â©2017 w1jp, Jon Pellant
	171105 origination
	171108 added sound
 -->
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
     <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/css/bootstrap.min.css" integrity="sha384-PsH8R72JQ3SOdhVi3uxftmaW6Vc51MKb0q5P2rRUpPvrszuE4W1povHYgTpBfshb" crossorigin="anonymous">
   <title>W1JP Jon Pellant</title>
	<style>
		.j-dark {
			background: black;
			height: 200px;
			width: 100%;
		}
	</style>
	<script src="vec2f.js"></script>
	<script src="beacon.js"></script>
	<script>
		const z = {
			tick: 0,
			ppms: 0.5, // pixels/ms for animation
			ttl: 2500, // time-to-live for pings
			wpm: 12,
			farnsworth: 20,
			antColor: "white",
			sigColor: "orange",
      btnColor: '#333',
			lineWidth: 2,
			pings: [],
			frequency: 600,
			sound: true,
		}
		const resizeCanvas = ()=>{
			const box = z.can.getBoundingClientRect()
			z.can.width = box.width
			z.can.height = box.height
			z.ctx = z.can.getContext('2d')
			z.antPos = new Vec2f(
				z.can.width/100*85,
				z.can.height/3)
		}
		const drawAntenna = () => {
			const r = 25 // antenna base radius (1/2 width)
			z.ctx.save()
			z.ctx.fillStyle = z.antColor
			z.ctx.strokeStyle = z.antColor
			z.ctx.lineWidth = z.lineWidth
			z.ctx.beginPath()
			z.ctx.moveTo(z.antPos.x, z.antPos.y)
			z.ctx.lineTo(z.antPos.x+r,z.can.height)
			z.ctx.stroke()
			z.ctx.beginPath()
			z.ctx.moveTo(z.antPos.x, z.antPos.y)
			z.ctx.lineTo(z.antPos.x-r,z.can.height)
			z.ctx.stroke()
			z.ctx.beginPath()
			z.ctx.arc(z.antPos.x, z.antPos.y, 5, 0, 2*Math.PI)
			z.ctx.fill()
			// supports
			const ah = z.can.height - z.antPos.y // antenna height
			const sh = ah/3 // section height
			const m = ah/(r) // slope of antenna
			// usng point slope: y-y1 = m(x-x1)
			// where (x1,y1) is antPos.
			// section 1
			z.ctx.beginPath()
			z.ctx.moveTo(z.antPos.x-r, z.can.height)
			z.ctx.lineTo(
				z.antPos.x + (z.can.height - sh - z.antPos.y)/m,
				z.can.height-sh)
			z.ctx.stroke()
			z.ctx.moveTo(z.antPos.x+r, z.can.height)
			z.ctx.lineTo(
				z.antPos.x + (z.can.height - sh - z.antPos.y)/-m,
				z.can.height-sh)
			z.ctx.stroke()
			// section 2
			z.ctx.beginPath()
			z.ctx.moveTo(
				z.antPos.x + (z.can.height - sh - z.antPos.y)/-m,
				z.can.height-sh)
			z.ctx.lineTo(
				z.antPos.x + (z.can.height - 2*sh - z.antPos.y)/m,
				z.can.height-2*sh)
			z.ctx.stroke()
			z.ctx.beginPath()
			z.ctx.moveTo(
				z.antPos.x + (z.can.height - sh - z.antPos.y)/m,
				z.can.height-sh)
			z.ctx.lineTo(
				z.antPos.x + (z.can.height - 2*sh - z.antPos.y)/-m,
				z.can.height-2*sh)
			z.ctx.stroke()
			// section 3
			z.ctx.beginPath()
			z.ctx.moveTo(
				z.antPos.x + (z.can.height - 2*sh - z.antPos.y)/-m,
				z.can.height-2*sh)
			z.ctx.lineTo(
				z.antPos.x + (z.can.height - 2.5*sh - z.antPos.y)/m,
				z.can.height-2.5*sh)
			z.ctx.stroke()
			z.ctx.beginPath()
			z.ctx.moveTo(
				z.antPos.x + (z.can.height - 2*sh - z.antPos.y)/m,
				z.can.height-2*sh)
			z.ctx.lineTo(
				z.antPos.x + (z.can.height - 2.5*sh - z.antPos.y)/-m,
				z.can.height-2.5*sh)
			z.ctx.stroke()
			z.ctx.restore()
		}
		const drawText = () => {
			z.ctx.save()
			z.ctx.font = '100px monospace'
			z.ctx.textAlign = 'left'
			z.ctx.textBaseline = 'middle'
			z.ctx.fillStyle = z.antColor
			z.ctx.fillText('W1JP', 50, z.can.height/2)
			z.ctx.font = '14pt monospace'
			z.ctx.textAlign = 'left'
			z.ctx.textBaseline = 'bottom'
			z.ctx.fillText('Â©2017 Jon Pellant', 60, z.can.height)
			z.ctx.restore()
		}
    const drawButtons = () => {
      let btnWidth = 30
      let text = (z.sound)? 'ðŸ”‡':'ðŸ”ˆ'
      let btn = new Vec2f(z.can.width-btnWidth-5, z.can.height-btnWidth-5)
      z.ctx.save()
      z.ctx.font = '14pt monospace'
      z.ctx.textAlign = 'center'
      z.ctx.textBaseline = 'middle'
      z.ctx.fillStyle = z.btnColor
      z.ctx.fillRect(btn.x, btn.y, btnWidth, btnWidth)
      z.ctx.fillStyle = z.antColor
      z.ctx.fillText(text,btn.x+btnWidth/2, btn.y+btnWidth/2)
      z.ctx.restore()
    }
		const updatePings = (timer) => {
			z.pings.forEach((ping, i) => {
				let elapsed = timer-ping.start
				if (elapsed<0) elapsed = 0
				if (elapsed > z.ttl) z.pings.splice(i, 1)
				else {
					z.ctx.save()
					z.ctx.strokeStyle = z.sigColor
					z.ctx.lineWidth = (ping.type == 1)? z.lineWidth : z.lineWidth*3
					z.ctx.beginPath()
					z.ctx.arc(z.antPos.x, z.antPos.y, z.ppms*elapsed, 0, 2*Math.PI)
					z.ctx.stroke()
					z.ctx.restore()
				}
			})
		}
		const newPing = (type) => {
			z.pings.push({type, start: performance.now()})
			if (z.pings.length == 1) window.requestAnimationFrame(draw)
			// start sound
			if (z.ax != undefined && z.sound){
				window.setTimeout(stopSound, (type==1)? z.beacon.tickPeriod : 3*z.beacon.tickPeriod)
				z.ax.resume()
			}
		}

		const stopSound = () => {
			z.ax.suspend()
		}

    const eClick = (e) => {
      z.sound = !z.sound
      stopSound()
    }

		const draw = (timer) => {
			z.ctx.clearRect(0,0, z.can.width, z.can.height)
			drawText()
			drawAntenna()
      drawButtons()
			if (z.pings.length > 0) {
				updatePings(timer)
				window.requestAnimationFrame(draw)
			}
		}

		function init() {
			z.can = document.getElementById('can')
			// z.scale = ('devicePixelRatio' in window &&
			// 	window.devicePixelRatio > 1)?
			// 	window.devicePixelRatio : 1
			z.beacon = new Beacon(newPing)
			z.beacon.play()
			resizeCanvas()
			// set up sound
			const AudioFactory = window.AudioContext || window.webkitAudioContext
			if (AudioFactory == undefined) z.sound = false
			else {
				z.ax = new AudioFactory()
				const osc = z.ax.createOscillator()
				osc.type = 'sine'
				osc.frequency.value = z.frequency
        osc.connect(z.ax.destination)
				z.ax.suspend()
				osc.start()
        z.can.onclick = eClick
			}
			window.addEventListener('resize', resizeCanvas)
			window.requestAnimationFrame(draw)
		}
	</script>
</head>
<body onload="init()">
	<canvas id="can" class="j-dark"</canvas>
	<div class="container">
		<div class="row">
			<p>Welcome to my site.</p>
			<p>73,<br>Jon<br>W1JP</p>
		</div>
	</div>
    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.3/umd/popper.min.js" integrity="sha384-vFJXuSJphROIrBnz7yo7oB41mKfc8JzQZiCq4NCceLEaO4IHwicKwpJf9c9IpFgh" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/js/bootstrap.min.js" integrity="sha384-alpBpkh1PFOepccYVYDB4do5UnbKysX5WZXm3XxPqe5iKTfUKjNkCk9SaVuEZflJ" crossorigin="anonymous"></script>
</body>
</html>
